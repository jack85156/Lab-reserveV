<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-result {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        .test-result.success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        .test-result.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        .test-result.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Supabase Connection Diagnostic Test</h1>
    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="storage.js"></script>
    <script>
        const resultsDiv = document.getElementById('results');
        
        function addResult(title, message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${message}</pre>`;
            resultsDiv.appendChild(div);
        }

        async function runTests() {
            // Test 1: Check if Supabase library loaded
            addResult('Test 1: Supabase Library Check', 
                `window.supabase type: ${typeof window.supabase}\n` +
                `window.supabase: ${JSON.stringify(window.supabase, null, 2).substring(0, 200)}...`,
                typeof window.supabase !== 'undefined' ? 'success' : 'error'
            );

            // Test 2: Check if createClient is available
            let createClientAvailable = false;
            if (typeof window.supabase !== 'undefined') {
                if (typeof window.supabase.createClient === 'function') {
                    createClientAvailable = true;
                    addResult('Test 2: createClient Function', 
                        '‚úÖ Found: window.supabase.createClient',
                        'success'
                    );
                } else {
                    addResult('Test 2: createClient Function', 
                        '‚ùå window.supabase.createClient is not a function\n' +
                        `Available properties: ${Object.keys(window.supabase).join(', ')}`,
                        'error'
                    );
                }
            } else {
                addResult('Test 2: createClient Function', 
                    '‚ùå window.supabase is undefined',
                    'error'
                );
            }

            // Test 3: Check credentials
            const DEFAULT_SUPABASE_URL = 'https://ermkgvzfehlaaoktxndv.supabase.co';
            const DEFAULT_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVybWtndnpmZWhsYWFva3R4bmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMjk2MzYsImV4cCI6MjA3OTYwNTYzNn0.4WBtLgvjVeOgrznXkQa7W6aa4vFWgBvd3gIPXoIrVRI';
            
            const SUPABASE_URL = (typeof window !== 'undefined' && window.SUPABASE_URL) || DEFAULT_SUPABASE_URL;
            const SUPABASE_ANON_KEY = (typeof window !== 'undefined' && window.SUPABASE_ANON_KEY) || DEFAULT_SUPABASE_ANON_KEY;
            
            addResult('Test 3: Credentials Check', 
                `URL: ${SUPABASE_URL}\n` +
                `Key: ${SUPABASE_ANON_KEY.substring(0, 50)}...\n` +
                `URL valid: ${SUPABASE_URL && !SUPABASE_URL.includes('your-project-id')}\n` +
                `Key valid: ${SUPABASE_ANON_KEY && !SUPABASE_ANON_KEY.includes('your-anon-key')}`,
                (SUPABASE_URL && SUPABASE_ANON_KEY && 
                 !SUPABASE_URL.includes('your-project-id') && 
                 !SUPABASE_ANON_KEY.includes('your-anon-key')) ? 'success' : 'warning'
            );

            // Test 4: Try to create client
            if (createClientAvailable && SUPABASE_URL && SUPABASE_ANON_KEY) {
                try {
                    const testClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    addResult('Test 4: Client Creation', 
                        '‚úÖ Client created successfully\n' +
                        `Client type: ${typeof testClient}\n` +
                        `Client methods: ${Object.keys(testClient).slice(0, 10).join(', ')}...`,
                        'success'
                    );

                    // Test 5: Try to connect to database
                    try {
                        // First, test if we can reach the Supabase API endpoint
                        let apiReachable = false;
                        try {
                            const healthCheck = await fetch(`${SUPABASE_URL}/rest/v1/`, {
                                method: 'HEAD',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                }
                            });
                            apiReachable = healthCheck.ok || healthCheck.status < 500;
                            addResult('Test 5a: API Reachability', 
                                `Status: ${healthCheck.status}\n` +
                                `Reachable: ${apiReachable}\n` +
                                `URL: ${SUPABASE_URL}/rest/v1/`,
                                apiReachable ? 'success' : 'warning'
                            );
                        } catch (fetchError) {
                            addResult('Test 5a: API Reachability', 
                                `‚ùå Cannot reach Supabase API:\n${fetchError.message}\n\n` +
                                `Possible causes:\n` +
                                `1. Supabase project is paused - Check Supabase Dashboard\n` +
                                `2. Network/firewall blocking - Check your internet connection\n` +
                                `3. CORS issue - Add http://localhost:8000 to Supabase CORS settings\n` +
                                `4. Wrong Supabase URL - Verify in Supabase Dashboard ‚Üí Settings ‚Üí API`,
                                'error'
                            );
                        }

                        // Now try the database query
                        const { data, error } = await testClient
                            .from('bookings')
                            .select('id')
                            .limit(1);
                        
                        if (error) {
                            let errorDetails = `‚ùå Error connecting to database:\n${JSON.stringify(error, null, 2)}\n\n`;
                            
                            if (error.code === '42P01') {
                                errorDetails += `‚ö†Ô∏è Table 'bookings' does not exist!\n`;
                                errorDetails += `Fix: Create the table in Supabase Dashboard ‚Üí SQL Editor\n`;
                            } else if (error.code === '42501') {
                                errorDetails += `‚ö†Ô∏è Permission denied!\n`;
                                errorDetails += `Fix: Check Row Level Security (RLS) policies in Supabase Dashboard\n`;
                            } else if (error.message && error.message.includes('Failed to fetch')) {
                                errorDetails += `‚ö†Ô∏è Network/CORS issue!\n`;
                                errorDetails += `Fix: Add http://localhost:8000 to Supabase CORS settings:\n`;
                                errorDetails += `   1. Go to Supabase Dashboard ‚Üí Settings ‚Üí API\n`;
                                errorDetails += `   2. Under "CORS Configuration", add: http://localhost:8000\n`;
                                errorDetails += `   3. Or use * for development (less secure)\n`;
                            }
                            
                            addResult('Test 5: Database Connection', errorDetails, 'error');
                        } else {
                            addResult('Test 5: Database Connection', 
                                `‚úÖ Successfully connected to database!\n` +
                                `Response: ${JSON.stringify(data, null, 2)}`,
                                'success'
                            );
                        }
                    } catch (dbError) {
                        let errorDetails = `‚ùå Exception connecting to database:\n${dbError.message}\n\n`;
                        
                        if (dbError.message.includes('Failed to fetch')) {
                            errorDetails += `‚ö†Ô∏è This is a network/CORS issue!\n\n`;
                            errorDetails += `How to fix:\n`;
                            errorDetails += `1. Go to Supabase Dashboard ‚Üí Settings ‚Üí API\n`;
                            errorDetails += `2. Under "CORS Configuration", add: http://localhost:8000\n`;
                            errorDetails += `3. Save and try again\n\n`;
                            errorDetails += `Alternative: Check if your Supabase project is paused\n`;
                            errorDetails += `- Go to Supabase Dashboard\n`;
                            errorDetails += `- Make sure project status is "Active" (not "Paused")\n`;
                        }
                        
                        errorDetails += `\nFull error: ${dbError.stack}`;
                        addResult('Test 5: Database Connection', errorDetails, 'error');
                    }
                } catch (clientError) {
                    addResult('Test 4: Client Creation', 
                        `‚ùå Failed to create client:\n${clientError.message}\n${clientError.stack}`,
                        'error'
                    );
                }
            } else {
                addResult('Test 4: Client Creation', 
                    '‚è≠Ô∏è Skipped (prerequisites not met)',
                    'warning'
                );
            }

            // Test 6: Check Storage object
            if (typeof Storage !== 'undefined' && Storage) {
                addResult('Test 6: Storage Object', 
                    `‚úÖ Storage object available\n` +
                    `Methods: ${Object.keys(Storage).join(', ')}`,
                    'success'
                );

                // Test 7: Try to get reservations
                try {
                    const reservations = await Storage.getReservations();
                    addResult('Test 7: Get Reservations', 
                        `‚úÖ Successfully retrieved reservations\n` +
                        `Count: ${reservations.length}\n` +
                        `Storage type: ${Storage.storageType || 'unknown'}`,
                        'success'
                    );
                } catch (storageError) {
                    addResult('Test 7: Get Reservations', 
                        `‚ùå Failed to get reservations:\n${storageError.message}\n${storageError.stack}`,
                        'error'
                    );
                }
            } else {
                addResult('Test 6: Storage Object', 
                    '‚ùå Storage object not available',
                    'error'
                );
            }
        }

        // Run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(runTests, 500); // Wait a bit for scripts to load
        });
    </script>
</body>
</html>





